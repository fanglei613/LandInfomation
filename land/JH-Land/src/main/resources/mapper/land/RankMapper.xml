<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jh.land.mapping.IRankMapper" >
      <resultMap id = "BaseResultMap" type="com.jh.land.entity.InitRank">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="rank_id" property="rankId" jdbcType="BIGINT" />
    <result column="data_status" property="dataStatus" jdbcType="CHAR" />
    <result column="del_flag" property="delFlag" jdbcType="CHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="creator_name" property="creatorName" jdbcType="VARCHAR" />
    <result column="creator" property="creator" jdbcType="INTEGER" />
    <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP" />
    <result column="modifier_name" property="modifierName" jdbcType="VARCHAR" />
    <result column="modifier" property="modifier" jdbcType="INTEGER" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="rank_code" property="rankCode" jdbcType="VARCHAR" />
    <result column="rank_name" property="rankName" jdbcType="VARCHAR" />
    <result column="china_name" property="chinaName" jdbcType="VARCHAR" />
    <result column="level" property="level" jdbcType="INTEGER" />
    <result column="parent_id" property="parentId" jdbcType="BIGINT" />
    <result column="area" property="area" jdbcType="NUMERIC" />
    <result column="lon" property="lon" jdbcType="NUMERIC" />
    <result column="lat" property="lat" jdbcType="NUMERIC" />
    <result column="bbox" property="bbox" jdbcType="OTHER" />
    <result column="vertex_bbox" property="vertexBbox" jdbcType="OTHER" />
    <result column="strip_number" property="stripNumber" jdbcType="VARCHAR" />
    <result column="centroid" property="centroid" jdbcType="OTHER" />
<!--    <result column="crop_id" property="cropId" jdbcType="INTEGER" />-->
  </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    rank_id, data_status, del_flag, create_time, creator_name, creator, modify_time, 
    modifier_name, modifier, remark, rank_code, rank_name, china_name, level, parent_id, 
    area, lon, lat, bbox, vertex_bbox, strip_number, centroid, crop_id
  </sql>

 <select id="queryRegionRankStatistics" parameterType="java.lang.Long" resultType="com.jh.land.model.RankParam">
   SELECT DISTINCT
        ( parent_id ) AS parentId,
        count( 0 ) AS rankNum,
        sum( area ) AS areaSum
    FROM
        init_rank
    WHERE
        parent_id IN ( SELECT region_id FROM init_region WHERE parent_id = #{parentId,jdbcType=BIGINT} )
    GROUP BY
        parent_id
 </select>

<!--根据条件查询地块分布数据的时间点集合-->
    <select id="findRankTimes" resultType="java.lang.String" parameterType="com.jh.land.model.RankParam" >
         SELECT DISTINCT
        to_char(data_time, 'yyyy-MM-dd') AS dataTime
        FROM
        rank_times
        WHERE
        region_id IN ( SELECT region_id FROM init_region WHERE region_code like #{regionCode,jdbcType=VARCHAR} || '%' )
        and data_time BETWEEN #{startDate,jdbcType=DATE} AND #{endDate,jdbcType=DATE}
        order by dataTime asc
  </select>

  <delete id="deleteRankInfo" parameterType="com.jh.land.model.RankAreaTaskVO">
      DELETE FROM ${tableName} WHERE data_status = '1' AND del_flag = '1' and data_time =  #{dataTime,jdbcType=TIMESTAMP} and rank_code like '%' || #{regionCode,jdbcType=VARCHAR} || '%'
  </delete>

    <select id="findAllRankTables" resultType="java.lang.String" parameterType="java.lang.String">
         SELECT DISTINCT(table_name) as tableName
         from information_schema.columns
         WHERE table_name like #{tableType,jdbcType=VARCHAR} || '%'
    </select>


    <select id="totalRegionRankStatistics" parameterType="com.jh.land.model.RankParam" resultType="com.jh.land.entity.RankStatistics">
        SELECT DISTINCT
        ( parent_id ) AS "regionId",
        count( 0 ) AS "rankNum",
        sum( area ) AS "areaSum",
        data_time AS "dataTime",
        split_part(rank_code ,'_', 1) as "regionCode"
        FROM
        ${rankTableName}
        GROUP BY
        parent_id,data_time,split_part(rank_code ,'_', 1)
    </select>

    <select id="totalRegionRankTimes" parameterType="com.jh.land.model.RankParam" resultType="HashMap">
        SELECT DISTINCT
            ( data_time ) AS "dataTime",
            parent_id AS "regionId"
        FROM
            ${rankTableName}
        ORDER BY
            data_time,parent_id
    </select>

    <!-- 基于区县乡镇级的地块面积及数量信息查询 -->
    <select id="findRankByCounty" parameterType="com.jh.land.model.RankVO" resultType="com.jh.land.model.RankVO">
        SELECT DISTINCT
            r.region_id AS "regionId",
            r.china_name AS "chinaName",
            s.area_sum AS "area",
            s.rank_num AS "rankNum",
            s.data_time AS "dataTime",
            r.level
        FROM
            ( SELECT region_id, china_name, LEVEL FROM init_region WHERE region_id = #{regionId,jdbcType=BIGINT} OR parent_id = #{regionId,jdbcType=BIGINT}) r
            LEFT JOIN rank_statistics s ON r.region_id = s.region_id
            AND s.data_time BETWEEN #{startDate,jdbcType=DATE} AND #{endDate,jdbcType=DATE}
        ORDER BY
            r.region_id DESC
    </select>

    <select id="findTheLatestTwoYearsByRank" resultType="java.lang.Integer" parameterType="com.jh.land.model.RankVO">
        SELECT DISTINCT
            to_char(data_time, 'yyyy') AS dataTime
        FROM
            rank_statistics
        WHERE
            region_id IN ( SELECT region_id FROM init_region WHERE region_code like #{regionCode,jdbcType=VARCHAR} || '%' )
            AND data_time &lt;=#{endDate,jdbcType=DATE}
        order by dataTime desc limit 2
    </select>

</mapper>