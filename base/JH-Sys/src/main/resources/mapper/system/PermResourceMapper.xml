<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jh.system.mapping.IPermResourceMapper" >
  <resultMap id="BaseResultMap" type="com.jh.system.entity.PermResource" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="res_id" property="resId" jdbcType="INTEGER" />
    <result column="data_status" property="dataStatus" jdbcType="CHAR" />
    <result column="del_flag" property="delFlag" jdbcType="CHAR" />
    <result column="create_time" property="createTime" jdbcType="DATE" />
    <result column="creator_name" property="creatorName" jdbcType="VARCHAR" />
    <result column="creator" property="creator" jdbcType="INTEGER" />
    <result column="modify_time" property="modifyTime" jdbcType="DATE" />
    <result column="modifier_name" property="modifierName" jdbcType="VARCHAR" />
    <result column="modifier" property="modifier" jdbcType="INTEGER" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="res_code" property="resCode" jdbcType="VARCHAR" />
    <result column="res_type" property="resType" jdbcType="INTEGER" />
    <result column="res_name" property="resName" jdbcType="VARCHAR" />
    <result column="res_url" property="resUrl" jdbcType="VARCHAR" />
    <result column="ico_style" property="icoStyle" jdbcType="VARCHAR" />
    <result column="res_no" property="resNo" jdbcType="SMALLINT" />
    <result column="is_leaf" property="isLeaf" jdbcType="BIT" />
    <result column="parent_id" property="parentId" jdbcType="INTEGER" />
    <result column="role_id" property="roleId" jdbcType="INTEGER" />
    <result column="parent_name" property="parentName" jdbcType="VARCHAR" />
    <result column="res_type_name" property="resTypeName" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    res_id, data_status, del_flag, create_time, creator_name, creator, modify_time, modifier_name, 
    modifier, remark, res_code, res_type, res_name, res_url, ico_style, res_no, is_leaf, 
    parent_id
  </sql>

  <select id="findByPage" resultMap="BaseResultMap" parameterType="ResourceParam">
    select
    a.res_id, a.data_status, a.del_flag, a.create_time, a.creator_name, a.creator, a.modify_time, a.modifier_name,
    a.modifier, a.remark, a.res_code, a.res_type, a.res_name, a.res_url, a.ico_style, a.res_no, a.is_leaf,
    a.parent_id, b.res_name as parent_name, c.data_name as resTypeName
    from sys_perm_resource a left join sys_perm_resource b on a.parent_id = b.res_id
    left join init_dict c on a.res_type = c.dict_id and c.parent_id = 200
    where a.data_status = '1' and a.del_flag = '1'

    <if test="resName != null and resName != ''">
      and a.res_name like '%'|| #{resName, jdbcType=VARCHAR} ||'%'
    </if>

    <if test="resCode != null and resCode != ''">
      and a.res_code = #{resCode,jdbcType=VARCHAR}
    </if>

    <if test="parentId != null and parentId != ''">
      and a.parent_id = #{parentId,jdbcType=INTEGER}
    </if>
    order by  a.res_id desc
  </select>

    <!-- 根据父节点查找子节点树 -->
    <select id="findResourceByParentId" resultMap="BaseResultMap" parameterType="ResourceParam">
        select res_id, data_status, del_flag, create_time, creator_name, creator, modify_time, modifier_name,
        modifier, remark, res_code, res_type, res_name, res_url, ico_style, res_no, is_leaf,parent_id
        from sys_perm_resource where del_flag = '1'
        <if test="parentId != null ">
            and parent_id = #{parentId,jdbcType=INTEGER}
        </if>
        order by res_no,is_leaf,parent_id
    </select>


  <!--校验资源编码是否唯一，已删除的记录也要考虑在内，因为表字段做了唯一性校验-->
  <select id="getByResCode" resultMap="BaseResultMap">
    select <include refid="Base_Column_List" />
    from sys_perm_resource where del_flag = '1' and res_code = #{resCode}
  </select>

  <select id="getByResName" resultMap="BaseResultMap" >
    select <include refid="Base_Column_List" />
    from sys_perm_resource where del_flag = '1' and res_name = #{resName}
  </select>

  <select id="getById" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <include refid="Base_Column_List" />
    from sys_perm_resource
    where res_id = #{resId,jdbcType=INTEGER}
  </select>
  <delete id="delete" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update sys_perm_resource set del_flag = 0
    where res_id = #{resId,jdbcType=INTEGER}
  </delete>
  <insert id="save" parameterType="PermResource" useGeneratedKeys="true" keyProperty="resId">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    insert into sys_perm_resource
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="dataStatus != null" >
        data_status,
      </if>
      <if test="delFlag != null" >
        del_flag,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="creatorName != null" >
        creator_name,
      </if>
      <if test="creator != null" >
        creator,
      </if>
      <if test="modifyTime != null" >
        modify_time,
      </if>
      <if test="modifierName != null" >
        modifier_name,
      </if>
      <if test="modifier != null" >
        modifier,
      </if>
      <if test="remark != null" >
        remark,
      </if>
      <if test="resCode != null" >
        res_code,
      </if>
      <if test="resType != null" >
        res_type,
      </if>
      <if test="resName != null" >
        res_name,
      </if>
      <if test="resUrl != null" >
        res_url,
      </if>
      <if test="icoStyle != null" >
        ico_style,
      </if>
      <if test="resNo != null" >
        res_no,
      </if>
      <if test="isLeaf != null" >
        is_leaf,
      </if>
      <if test="parentId != null" >
        parent_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="dataStatus != null" >
        #{dataStatus,jdbcType=CHAR},
      </if>
      <if test="delFlag != null" >
        #{delFlag,jdbcType=CHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=DATE},
      </if>
      <if test="creatorName != null" >
        #{creatorName,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        #{creator,jdbcType=INTEGER},
      </if>
      <if test="modifyTime != null" >
        #{modifyTime,jdbcType=DATE},
      </if>
      <if test="modifierName != null" >
        #{modifierName,jdbcType=VARCHAR},
      </if>
      <if test="modifier != null" >
        #{modifier,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="resCode != null" >
        #{resCode,jdbcType=VARCHAR},
      </if>
      <if test="resType != null" >
        #{resType,jdbcType=BIGINT},
      </if>
      <if test="resName != null" >
        #{resName,jdbcType=VARCHAR},
      </if>
      <if test="resUrl != null" >
        #{resUrl,jdbcType=VARCHAR},
      </if>
      <if test="icoStyle != null" >
        #{icoStyle,jdbcType=VARCHAR},
      </if>
      <if test="resNo != null" >
        #{resNo,jdbcType=SMALLINT},
      </if>
      <if test="isLeaf != null" >
        #{isLeaf,jdbcType=BIT},
      </if>
      <if test="parentId != null" >
        #{parentId,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateResouce" parameterType="PermResource" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update sys_perm_resource
    <set >
      <if test="dataStatus != null" >
        data_status = #{dataStatus,jdbcType=CHAR},
      </if>
      <if test="delFlag != null" >
        del_flag = #{delFlag,jdbcType=CHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=DATE},
      </if>
      <if test="creatorName != null" >
        creator_name = #{creatorName,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        creator = #{creator,jdbcType=INTEGER},
      </if>
      <if test="modifyTime != null" >
        modify_time = #{modifyTime,jdbcType=DATE},
      </if>
      <if test="modifierName != null" >
        modifier_name = #{modifierName,jdbcType=VARCHAR},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        remark = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="resCode != null" >
        res_code = #{resCode,jdbcType=VARCHAR},
      </if>
      <if test="resType != null" >
        res_type = #{resType,jdbcType=BIGINT},
      </if>
      <if test="resName != null" >
        res_name = #{resName,jdbcType=VARCHAR},
      </if>
      <if test="resUrl != null" >
        res_url = #{resUrl,jdbcType=VARCHAR},
      </if>
      <if test="icoStyle != null" >
        ico_style = #{icoStyle,jdbcType=VARCHAR},
      </if>
      <if test="resNo != null" >
        res_no = #{resNo,jdbcType=SMALLINT},
      </if>
      <if test="isLeaf != null" >
        is_leaf = #{isLeaf,jdbcType=BIT},
      </if>
      <if test="parentId != null" >
        parent_id = #{parentId,jdbcType=INTEGER},
      </if>
    </set>
    where res_id = #{resId,jdbcType=INTEGER}
  </update>

    <!-- 修改状态-->
    <update id="updateResouceForStatus" parameterType="PermResource" >
        update sys_perm_resource
        <set >
            <if test="dataStatus != null" >
                data_status = #{dataStatus},
            </if>
        </set>
        where parent_id = #{resId}
    </update>


  <select id="findAllResource" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List" /> FROM sys_perm_resource where del_flag='1' order by res_no,is_leaf,parent_id
  </select>

  <select id="findAll" resultMap="BaseResultMap" >
    select a.res_id , a.res_code ,a.res_name,a.parent_id
    from sys_perm_resource a
    where a.data_status = '1'  and a.is_leaf = false and a.del_flag = '1'
  </select>

  <select id="findAllWithRole" resultMap="BaseResultMap" parameterType="Integer">
    select a.res_id , a.res_code ,a.res_name,a.parent_id,b.role_id
    from sys_perm_resource a
    left join sys_relate_role_res b on a.res_id = b.res_id  and b.role_id = #{roleId,jdbcType=INTEGER}
    where a.data_status = '1' and a.del_flag = '1'
    order by a.is_leaf desc,a.res_no, a.res_id desc
  </select>

    <select id="findSubSystemByAccountId" resultMap="BaseResultMap" parameterType="Integer">
      select a.res_id, a.res_code, a.res_name , a.parent_id, a.res_url, a.res_no
      from sys_perm_resource a,
       sys_relate_role_res b
      where a.res_id = b.res_id and a.res_type = 201 and a.del_flag = '1' and a.data_status = '1'
      and b.role_id in  (select role_id from sys_relate_account_role c where  c.account_id = #{accountId})
			order by a.res_no
    </select>


  <select id="findMenu" resultMap="BaseResultMap" parameterType="map">
		select res_id,res_name,res_url,is_leaf,parent_id,res_no,ico_style,res_type,data_status,res_code
		from sys_perm_resource
		where del_flag = '1' and data_status = '1' and res_type in (201,202)
--         and (remark != 'forum' or remark IS NULL)
		and res_id in (
          select  distinct(res_id) from sys_relate_role_res where
            role_id in(
              select relateRole.role_id from sys_relate_account_role relateRole left join sys_perm_role sysRole on relateRole.role_id = sysRole.role_id
               where relateRole.account_id=#{accountId,jdbcType=INTEGER} and sysRole.role_type = #{roleType,jdbcType=INTEGER}
            )
		)
        order by res_no,is_leaf,parent_id

  </select>

    <select id="findById" resultMap="BaseResultMap" parameterType="map">
        select
        a.res_id, a.data_status, a.del_flag, a.create_time, a.creator_name, a.creator, a.modify_time, a.modifier_name,
        a.modifier, a.remark, a.res_code, a.res_type, a.res_name, a.res_url, a.ico_style, a.res_no, a.is_leaf,
        a.parent_id, b.res_name as parent_name, c.data_name as res_type_name
        from sys_perm_resource a left join sys_perm_resource b on a.parent_id = b.res_id
        left join init_dict c on a.res_type = c.dict_id and c.parent_id = 200
        where a.del_flag = '1' and a.res_id=#{resId,jdbcType=INTEGER}
    </select>

  <select id="findButton" resultMap="BaseResultMap" parameterType="map">
    select res_id as resId,res_name,res_url,is_leaf,parent_id,res_no,ico_style,res_type,data_status,res_code
    from sys_perm_resource
    where del_flag = '1' and data_status = '1' and res_type in (201,203) and res_id in(
      select  distinct(res_id) from sys_relate_role_res where
      role_id in(select role_id from sys_relate_account_role where account_id=#{accountId,jdbcType=INTEGER})
    ) and res_code = #{resCode,jdbcType=VARCHAR}
  </select>

  <select id="queryAppMenus" parameterType="map" resultType="map">
    select res_code as resCode from sys_perm_resource  where res_id in (
      select res_id from sys_relate_account_role a
        left join sys_relate_role_res b on a.role_id = b.role_id
      where account_id = #{accountId} )
      and res_code in
    <foreach collection="appMenus" item="appMenu" open="(" close=")" separator=",">
      #{appMenu,jdbcType=VARCHAR}
    </foreach>
  </select>
</mapper>